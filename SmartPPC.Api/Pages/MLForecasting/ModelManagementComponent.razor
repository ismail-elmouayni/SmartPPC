@using SmartPPC.Api.Services
@using SmartPPC.Core.ML.Services
@using SmartPPC.Core.ML.Domain
@inject ConfigurationStateService StateService
@inject IForecastingService ForecastingService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Model Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.ManageAccounts" /> ML Model Management
    </MudText>

    @if (!StateService.HasConfiguration)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            Please load a configuration first from the Dashboard.
        </MudAlert>
    }
    else
    {
        <MudPaper Elevation="3" Class="pa-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">Trained Models</MudText>
                <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" Href="/MLForecasting/ModelTraining">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-1" /> Train New Model
                </MudButton>
            </div>

            @if (_isLoading)
            {
                <MudProgressLinear Indeterminate />
            }
            else if (_models == null || !_models.Any())
            {
                <MudAlert Severity="Severity.Info">
                    No models found. Train your first model to get started!
                </MudAlert>
            }
            else
            {
                <MudTable Items="@_models" Hover Dense Striped>
                    <HeaderContent>
                        <MudTh>Status</MudTh>
                        <MudTh>Name</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Created</MudTh>
                        <MudTh>MAE</MudTh>
                        <MudTh>MAPE</MudTh>
                        <MudTh>RMSE</MudTh>
                        <MudTh>RÂ²</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            @if (context.IsActive)
                            {
                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Success">Active</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Default">Inactive</MudChip>
                            }
                        </MudTd>
                        <MudTd>@context.Name</MudTd>
                        <MudTd>@context.ModelType</MudTd>
                        <MudTd>@context.CreatedAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd>@context.ValidationMAE?.ToString("F2")</MudTd>
                        <MudTd>@context.ValidationMAPE.ToString("F2")%</MudTd>
                        <MudTd>@context.ValidationRMSE?.ToString("F2")</MudTd>
                        <MudTd>@context.ValidationAccuracy?.ToString("F4")</MudTd>
                        <MudTd>
                            <MudButtonGroup Size="MudBlazor.Size.Small">
                                @if (!context.IsActive)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                                                   Color="MudBlazor.Color.Success"
                                                   Size="MudBlazor.Size.Small"
                                                   OnClick="@(() => ActivateModel(context.Id))"
                                                   Title="Activate Model" />
                                }
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="MudBlazor.Color.Error"
                                               Size="MudBlazor.Size.Small"
                                               OnClick="@(() => DeleteModel(context.Id))"
                                               Title="Delete Model" />
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private bool _isLoading = false;
    private List<ForecastModel>? _models;

    protected override async Task OnInitializedAsync()
    {
        await LoadModels();
    }

    private async Task LoadModels()
    {
        if (!StateService.HasConfiguration)
            return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            var result = await ForecastingService.ListModelsAsync(
                StateService.CurrentConfigId.Value,
                includeInactive: true);

            if (result.IsSuccess)
            {
                _models = result.Value.ToList();
            }
            else
            {
                Snackbar.Add($"Failed to load models: {result.Errors.First().Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ActivateModel(Guid modelId)
    {
        var result = await ForecastingService.ActivateModelAsync(modelId);

        if (result.IsSuccess)
        {
            Snackbar.Add("Model activated successfully!", Severity.Success);
            await LoadModels();
        }
        else
        {
            Snackbar.Add($"Activation failed: {result.Errors.First().Message}", Severity.Error);
        }
    }

    private async Task DeleteModel(Guid modelId)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this model? This will also delete all associated predictions and metrics.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await ForecastingService.DeleteModelAsync(modelId);

            if (result.IsSuccess)
            {
                Snackbar.Add("Model deleted successfully!", Severity.Success);
                await LoadModels();
            }
            else
            {
                Snackbar.Add($"Deletion failed: {result.Errors.First().Message}", Severity.Error);
            }
        }
    }
}
